# 圖像題目提取系統

一個基於Python的圖像題目提取和管理系統，使用OpenRouter的Qwen3 VL模型識別圖片中的題目和選項，提供完整的GUI界面進行題目管理。

## 功能特性

- **批量圖像處理**: 支援批量上傳圖片，自動識別題目和選項
- **智慧識別**: 使用OpenRouter的Qwen3 VL視覺模型，準確識別圖片中的文字內容
- **自動去重**: 智慧識別重複題目，即使選項順序不同也能正確去重
- **近似比對**: 發現近似題目時彈出比對視窗，讓您選擇保留哪個版本
- **背景處理**: AI 判讀在背景持續進行，比對視窗不影響處理進度
- **圖片管理**: 自動儲存題目相關圖片，支援點擊查看原圖
- **智慧縮放**: 圖片自動等比縮小至短邊 1200px，使用高質量 LANCZOS 演算法保持文字清晰
- **題目管理**: 提供完整的增刪改查功能
- **正確答案標記**: 支援使用複選框標記正確答案，支援單選和多選
- **題庫檔案管理**: 支援開啟、另存為、匯入題庫檔案，方便管理多個題庫
- **搜尋功能**: 支援關鍵詞搜尋題目和選項
- **可調整參數**: 透過配置檔案調整相似度閾值和權重
- **資料持久化**: 使用JSON格式儲存題目庫
- **題庫匯出**: 匯出為純文字格式，包含正確答案標記，便於使用

## 系統要求

- Python 3.7+
- Windows/Linux/MacOS
- OpenRouter API密鑰（需註冊獲取）

## 安裝步驟

1. 克隆或下載本專案

2. 安裝依賴套件：
```bash
pip install -r requirements.txt
```

3. 配置API密鑰：
   - 方式1: 直接編輯 `config.json` 檔案，填入你的OpenRouter API密鑰
   - 方式2: 執行程式後，點擊「設置API密鑰」按鈕進行配置

## 使用說明

### 1. 啟動程式

```bash
python main.py
```

### 2. 配置API密鑰

首次使用需要配置OpenRouter API密鑰：

1. 點擊左側「設置API密鑰」按鈕
2. 輸入你的OpenRouter API密鑰
3. 點擊儲存

**獲取API密鑰:**
- 訪問 [OpenRouter](https://openrouter.ai/)
- 註冊帳號並獲取API密鑰

### 3. 批量上傳圖片

1. 點擊「批量上傳圖片」按鈕
2. 選擇一張或多張包含題目的圖片
3. 系統會自動識別並提取題目和選項
4. **自動去重**: 系統會自動檢測重複題目，即使選項順序不同也能識別
5. **圖片儲存**: 圖片會自動儲存到 `images/` 目錄，重複題目不會重複儲存
6. 處理進度會顯示在日誌區域，包含新增和重複的統計
7. 完成後題目會自動添加到題目庫

### 4. 題庫檔案管理

**開啟題庫:**
1. 點擊「開啟題庫」按鈕
2. 選擇要開啟的題庫JSON檔案
3. 系統會載入該題庫並顯示所有題目

**題庫另存為:**
1. 點擊「題庫另存為」按鈕
2. 選擇儲存位置和檔案名稱
3. 當前題庫會被儲存到新的檔案

**匯入題庫:**
1. 點擊「匯入題庫」按鈕
2. 選擇要匯入的題庫JSON檔案
3. 該題庫中的所有題目會被合併到當前題庫中
4. 系統會自動重新分配ID避免衝突

### 5. 管理題目

**查看題目:**
- 題目列表會顯示所有已提取的題目
- 點擊任意題目可在下方查看詳情
- **查看圖片**: 題目詳情區域會顯示圖片連結，點擊「點擊查看圖片」可用系統預設程式開啟原圖

**編輯題目:**
1. 在列表中選擇要編輯的題目
2. 在詳情區域修改題目內容或選項
3. 勾選「正確答案」複選框標記正確答案（支援多選）
4. 點擊「儲存修改」按鈕

**刪除題目:**
1. 在列表中選擇要刪除的題目
2. 點擊「刪除題目」按鈕
3. 確認刪除操作

**搜尋題目:**
1. 在頂部搜尋框輸入關鍵詞
2. 點擊「搜尋」按鈕
3. 系統會搜尋題目內容和選項

### 6. 匯出題庫

1. 點擊「匯出題庫」按鈕
2. 選擇儲存位置和檔案名稱
3. 題庫會匯出為以下格式：

```
1.(A)你叫什麼名字
A.Tom B.Jack C.BB D.CC

2.今天星期幾
A.星期一 B.星期二 C.星期三 D.星期四

3.(BD)多選題範例
A.選項A B.選項B C.選項C D.選項D
```

**說明:**
- 有設定正確答案的題目會在題號後顯示括號內的答案，例如：`1.(A)題目內容`
- 支援多選題，例如：`3.(BD)題目內容` 表示B和D都是正確答案
- 未設定正確答案的題目則正常顯示，例如：`2.題目內容`

## 檔案結構

```
itt/
├── main.py                 # 主程式（GUI界面）
├── api_client.py           # OpenRouter API客戶端
├── question_database.py    # 題目資料庫管理（含去重邏輯）
├── config.json             # 配置檔案（儲存API密鑰）
├── questions_db.json       # 題目資料庫（自動生成）
├── images/                 # 圖片儲存目錄（自動生成）
├── requirements.txt        # Python依賴
├── README.md              # 說明文件
└── CLAUDE.md              # 開發者指南
```

## 配置檔案說明

`config.json` 配置項：

```json
{
    "openrouter_api_key": "你的API密鑰",
    "model": "qwen/qwen3-vl-235b-a22b-instruct",
    "site_url": "http://localhost",
    "site_name": "Question Extractor",
    "similarity_threshold": 0.75,
    "question_weight": 0.6,
    "options_weight": 0.4
}
```

- `openrouter_api_key`: OpenRouter API密鑰（必填）
- `model`: 使用的模型名稱（預設為Qwen3 VL）
- `site_url`: 網站URL（可選）
- `site_name`: 網站名稱（可選）
- `similarity_threshold`: 近似題目相似度閾值（0.0-1.0，預設 0.75）
- `question_weight`: 題目內容的權重（預設 0.6）
- `options_weight`: 選項內容的權重（預設 0.4）

**調整建議：**
- `similarity_threshold` 越高，越嚴格（0.8-0.9 適合精確比對）
- `similarity_threshold` 越低，越寬鬆（0.6-0.7 適合模糊比對）
- `question_weight` 和 `options_weight` 總和應為 1.0

## 注意事項

1. **圖片品質**: 圖片需要清晰可讀，建議解析度不要太低
2. **題目格式**: 系統會盡量識別標準的選擇題格式（題目 + A/B/C/D選項）
3. **API費用**: 使用OpenRouter API需要付費，請注意控制使用量
4. **資料備份**: 題目資料儲存在 `questions_db.json` 檔案中，圖片儲存在 `images/` 目錄，建議定期備份
5. **去重機制**: 系統會自動去重，重複上傳相同題目不會重複添加
6. **圖片儲存**: 圖片使用 hash 值命名儲存，重複題目共享同一張圖片

## 常見問題

**Q: 識別效果不好怎麼辦？**
A: 確保圖片清晰，題目格式規範。可以嘗試裁剪圖片只保留題目部分。

**Q: API調用失敗怎麼辦？**
A: 檢查API密鑰是否正確，網路連線是否正常，OpenRouter帳戶餘額是否充足。

**Q: 可以修改識別提示詞嗎？**
A: 可以編輯 `api_client.py` 檔案中的 `extract_questions_from_image` 方法，修改prompt變數。

**Q: 支援其他語言嗎？**
A: 系統支援多語言，但主要針對中文最佳化。Qwen3模型支援多種語言識別。

**Q: 如何備份題庫？**
A: 題目資料儲存在JSON檔案中。使用「題庫另存為」功能可以複製題庫到其他位置進行備份。

**Q: 可以合併多個題庫嗎？**
A: 可以。使用「匯入題庫」功能將其他題庫的題目合併到當前題庫中，系統會自動處理ID衝突。

**Q: 題庫檔案可以手動編輯嗎？**
A: 可以，題庫檔案是標準的JSON格式，可以使用文字編輯器直接編輯。但建議使用程式介面操作以避免格式錯誤。

**Q: 如何判斷題目是否重複？**
A: 系統使用 hash 機制比對題目內容和所有選項內容。即使選項順序不同（例如 A 和 B 對調），只要題目和選項內容相同，就會被視為重複。

**Q: 重複題目的圖片會怎麼處理？**
A: 重複題目不會重複儲存圖片。第一次上傳時會儲存圖片，後續重複的題目會使用同一張圖片。

**Q: 什麼是近似比對？何時會觸發？**
A: 當新題目與已存在題目的相似度超過閾值（預設 0.75）但不完全相同時，系統會彈出比對視窗讓您選擇。例如「Python是什麼」和「Python 是什麼」（多了空格）會被識別為近似題目。

**Q: 比對視窗會阻塞圖片處理嗎？**
A: 不會！AI 判讀在背景執行緒持續進行，比對視窗只是讓您決定近似題目的處理方式。多個近似題目會依序彈出，不影響處理效率。

**Q: 如何調整相似度檢測的靈敏度？**
A: 編輯 `config.json` 中的 `similarity_threshold`：
- 設定為 0.9 = 很嚴格，只有非常相似才會提示
- 設定為 0.7 = 較寬鬆，稍微相似就會提示
- 設定為 0.6 = 很寬鬆，幾乎有點像就會提示

**Q: 如何調整題目和選項的重要性？**
A: 編輯 `config.json` 中的權重：
- `question_weight: 0.8, options_weight: 0.2` = 更重視題目文字
- `question_weight: 0.4, options_weight: 0.6` = 更重視選項內容

## 技術棧

- **GUI框架**: tkinter
- **HTTP請求**: requests
- **圖像處理**: Pillow
- **資料儲存**: JSON
- **AI模型**: OpenRouter Qwen3 VL

## 開發和貢獻

歡迎提交Issue和Pull Request。

## 授權條款

MIT License

## 使用場景

### 場景1: 建立新題庫
1. 啟動程式（預設會建立 questions_db.json）
2. 批量上傳圖片提取題目
3. 編輯題目並標記正確答案
4. 匯出為文字檔案使用

### 場景2: 管理多個題庫
1. 使用「題庫另存為」為不同科目建立獨立題庫
2. 使用「開啟題庫」切換不同的題庫檔案
3. 每個題庫可以獨立管理和匯出

### 場景3: 合併題庫
1. 開啟主題庫
2. 使用「匯入題庫」將其他題庫的題目合併進來
3. 系統會自動處理ID衝突

## 更新日誌

### v1.4.0 (2025)
- **新增近似比對功能**: 自動識別近似題目並彈出比對視窗讓使用者選擇
- **非阻塞處理**: AI 判讀在背景持續進行，比對視窗不影響處理進度
- **待處理清單**: 多個近似題目會依序彈出，逐一處理
- **可調整參數**: 透過配置檔案調整相似度閾值和權重
- 比對視窗顯示相似度百分比，方便判斷
- 支援三種選擇：保留新題目、保留舊題目、跳過
- **比對視窗圖片連結**: 每個題目卡片都可點擊查看原圖，方便比對哪個正確
- **圖片自動縮放**: 短邊超過 1200px 自動等比縮小，使用 LANCZOS 演算法保持文字清晰
- **格式統一**: 自動將 PNG 轉換為 JPEG，節省儲存空間

### v1.3.0 (2025)
- **新增自動去重功能**: 使用 hash 機制智慧識別重複題目
- **新增圖片管理**: 自動儲存圖片到 images 目錄，支援點擊查看
- **選項順序無關**: 即使選項順序不同，相同題目也能正確去重
- 批量處理顯示新增和重複統計
- UI 顯示圖片連結，支援跨平台開啟圖片

### v1.2.0 (2025)
- 新增開啟題庫功能
- 新增題庫另存為功能
- 新增匯入題庫功能（合併題庫）
- 顯示當前開啟的題庫檔案名稱
- 優化控制面板布局，分類顯示功能

### v1.1.0 (2025)
- 新增正確答案標記功能
- 支援單選和多選題答案設定
- 匯出格式包含正確答案顯示

### v1.0.0 (2025)
- 初始版本發布
- 支援批量圖像處理
- 完整的題目管理功能
- 題庫匯出功能
